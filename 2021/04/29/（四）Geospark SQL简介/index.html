<!DOCTYPE html>
<html>
  
<head>
  <meta charset="utf-8">
  <meta name="author" content="Zhang Xueliang" />
  
  
  <title>（四）Geospark SQL简介 | 学亮编程手记</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="GeoMesa,Spark," />
  

  
  <meta name="description" content="Spark提供DataFrame数据集，并且可以通过SQL语句来操作。GeoSpark在这个基础上实现了一些空间上的函数，可以用于SQL语句中，以下是本节要用到的5个，其余的函数参考GeoSpark SQL">

  

  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":false},
    welcome: {"enable":false,"interval":30},
    start_time: "2016-02-10",
    passwords: ["efe07af7441da2b69c4a41e42e73be4db47f66010a56900788a458354a7373ec", ],
    is_post: true,
    lock: false,
    author: "Zhang Xueliang",
    share: {"twitter":true,"facebook":true,"weibo":true,"qq":true,"wechat":true},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  
<script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>


  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  
<link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">


  
<meta name="generator" content="Hexo 5.4.0"></head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">学亮编程手记</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 殚精竭虑，不如须臾之所学也！</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/xueliang666/" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2021-04-29
    </span>
    
    
      <span>
        | <i class="fa fa-unlock-alt"></i>UNLOCK
      </span>
    
  </div>
  <h1 class="passage-title">
    （四）Geospark SQL简介
  </h1>
  
  <article class="passage-article">
    <h1 id="Geospark-SQL简介"><a href="#Geospark-SQL简介" class="headerlink" title="Geospark SQL简介"></a>Geospark SQL简介</h1><h3 id="GeoSpark-SQL简介"><a href="#GeoSpark-SQL简介" class="headerlink" title="GeoSpark SQL简介"></a>GeoSpark SQL简介</h3><p>Spark提供DataFrame数据集，并且可以通过SQL语句来操作。GeoSpark在这个基础上实现了一些空间上的函数，可以用于SQL语句中，以下是本节要用到的5个，其余的函数参考<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://datasystemslab.github.io/GeoSpark/api/sql/GeoSparkSQL-Function/">GeoSpark SQL</a></p>
<ol>
<li><code>ST_GeomFromWKT (Wkt:string, UUID1, UUID2, ...)</code>：从给出的WKT语句中构造Geometry</li>
<li><code>ST_Transform (A:geometry, SourceCRS:string, TargetCRS:string, [Optional] UseLongitudeLatitudeOrder:Boolean, [Optional] DisableError)</code>:默认情况下，<code>ST_Transform</code> 假设经度为x，维度为y，如果你的数据恰好相反， 那么设置<code>UseLongitudeLatitudeOrder</code>为 <code>false</code>.</li>
<li><code>ST_Contains (A:geometry, B:geometry)</code> : A是否完全包含B</li>
<li><code>ST_PolygonFromEnvelope (MinX:decimal, MinY:decimal, MaxX:decimal, MaxY:decimal, UUID1, UUID2, ...)</code>： 从给出的MinX，MinY，MinY、MaxY构造Polygon。</li>
<li><code>ST_PointFromText (Text:string, Delimiter:char, UUID1, UUID2, ...)</code>：从给定的坐标中构建Point</li>
</ol>
<h3 id="构建数据集，加载CSV文件"><a href="#构建数据集，加载CSV文件" class="headerlink" title="构建数据集，加载CSV文件"></a>构建数据集，加载CSV文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SparkSession spark = SparkSession.builder().</span><br><span class="line">        config(<span class="string">&quot;spark.serializer&quot;</span>,<span class="string">&quot;org.apache.spark.serializer.KryoSerializer&quot;</span>).</span><br><span class="line">        config(<span class="string">&quot;spark.kryo.registrator&quot;</span>, <span class="string">&quot;org.datasyslab.geospark.serde.GeoSparkKryoRegistrator&quot;</span>).</span><br><span class="line">        master(<span class="string">&quot;local[*]&quot;</span>).appName(<span class="string">&quot;Learn04&quot;</span>).getOrCreate();</span><br><span class="line"></span><br><span class="line">GeoSparkSQLRegistrator.registerAll(spark);</span><br><span class="line"><span class="comment">// 加载CSV文件,CSV中的第一列为WKT格式</span></span><br><span class="line">String inputCSVPath = Learn04.class.getResource(<span class="string">&quot;/county_small.tsv&quot;</span>).toString();</span><br><span class="line">Dataset rawDF = spark.read().format(<span class="string">&quot;csv&quot;</span>).</span><br><span class="line">        option(<span class="string">&quot;delimiter&quot;</span>, <span class="string">&quot;\t&quot;</span>).</span><br><span class="line">        option(<span class="string">&quot;header&quot;</span>, <span class="string">&quot;false&quot;</span>).</span><br><span class="line">        load(inputCSVPath);</span><br><span class="line">rawDF.createOrReplaceTempView(<span class="string">&quot;rawdf&quot;</span>);</span><br><span class="line">rawDF.show(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>此时Spark仅仅是构建了这么一个DataFrame，对于_c0来说，他不是Geometry，仅仅是字符串，所以我们需要增加一列geom</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+---+---+--------+-----+-----------+--------------------+---+---+-----+----+-----+----+----+----------+--------+-----------+------------+</span><br><span class="line"><span class="params">|                 _c0|</span>_c1<span class="params">|_c2|</span>     _c3<span class="params">|  _c4|</span>        _c5<span class="params">|                 _c6|</span>_c7<span class="params">|_c8|</span>  _c9<span class="params">|_c10|</span> _c11<span class="params">|_c12|</span>_c13<span class="params">|      _c14|</span>    _c15<span class="params">|       _c16|</span>        _c17<span class="params">|</span></span><br><span class="line"><span class="params">+--------------------+---+---+--------+-----+-----------+--------------------+---+---+-----+----+-----+----+----+----------+--------+-----------+------------+</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">97.019</span>...<span class="params">| 31|</span>039<span class="params">|00835841|</span><span class="number">31039</span><span class="params">|     Cuming|</span>       Cuming County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">| null|</span>null<span class="params">|   A|</span><span class="number">1477895811</span><span class="params">|10447360|</span>+<span class="number">41.9158651</span><span class="params">|-096.7885168|</span></span><br><span class="line"><span class="params">|POLYGON ((-123.43...|</span> <span class="number">53</span><span class="params">|069|</span><span class="number">01513275</span><span class="params">|53069|</span>  Wahkiakum<span class="params">|    Wahkiakum County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">|null|</span> null<span class="params">|null|</span>   A<span class="params">| 682138871|</span><span class="number">61658258</span><span class="params">|+46.2946377|</span>-<span class="number">123.4244583</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">104.56</span>...<span class="params">| 35|</span><span class="number">011</span><span class="params">|00933054|</span><span class="number">35011</span><span class="params">|    De Baca|</span>      De Baca County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">| null|</span>null<span class="params">|   A|</span><span class="number">6015539696</span><span class="params">|29159492|</span>+<span class="number">34.3592729</span><span class="params">|-104.3686961|</span></span><br><span class="line"><span class="params">|POLYGON ((-96.910...|</span> <span class="number">31</span><span class="params">|109|</span>00835876<span class="params">|31109|</span>  Lancaster<span class="params">|    Lancaster County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">| 339|</span><span class="number">30700</span><span class="params">|null|</span>   A<span class="params">|2169240202|</span><span class="number">22877180</span><span class="params">|+40.7835474|</span>-096.<span class="number">6886584</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">98.273</span>...<span class="params">| 31|</span><span class="number">129</span><span class="params">|00835886|</span><span class="number">31129</span><span class="params">|   Nuckolls|</span>     Nuckolls County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">| null|</span>null<span class="params">|   A|</span><span class="number">1489645187</span><span class="params">| 1718484|</span>+<span class="number">40.1764918</span><span class="params">|-098.0468422|</span></span><br><span class="line"><span class="params">|POLYGON ((-65.910...|</span> <span class="number">72</span><span class="params">|085|</span>01804523<span class="params">|72085|</span>Las Piedras<span class="params">|Las Piedras Munic...|</span> <span class="number">13</span><span class="params">| H1|</span>G4020<span class="params">| 490|</span><span class="number">41980</span><span class="params">|null|</span>   A<span class="params">|  87748363|</span>   <span class="number">32509</span><span class="params">|+18.1871483|</span>-<span class="number">065</span>.<span class="number">8711890</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">97.129</span>...<span class="params">| 46|</span>099<span class="params">|01265772|</span><span class="number">46099</span><span class="params">|  Minnehaha|</span>    Minnehaha County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">|43620|</span>null<span class="params">|   A|</span><span class="number">2090540341</span><span class="params">|17349847|</span>+<span class="number">43.6674723</span><span class="params">|-096.7957261|</span></span><br><span class="line"><span class="params">|POLYGON ((-99.821...|</span> <span class="number">48</span><span class="params">|327|</span>01383949<span class="params">|48327|</span>     Menard<span class="params">|       Menard County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">|null|</span> null<span class="params">|null|</span>   A<span class="params">|2336245914|</span>  <span class="number">613559</span><span class="params">|+30.8843655|</span>-099.<span class="number">8539896</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">120.65</span>...<span class="params">| 06|</span>091<span class="params">|00277310|</span>06091<span class="params">|     Sierra|</span>       Sierra County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">| null|</span>null<span class="params">|   A|</span><span class="number">2468686374</span><span class="params">|23299110|</span>+<span class="number">39.5769252</span><span class="params">|-120.5219926|</span></span><br><span class="line"><span class="params">|POLYGON ((-85.239...|</span> <span class="number">21</span><span class="params">|053|</span>00516873<span class="params">|21053|</span>    Clinton<span class="params">|      Clinton County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">|null|</span> null<span class="params">|null|</span>   A<span class="params">| 510864252|</span><span class="number">21164150</span><span class="params">|+36.7288647|</span>-085.<span class="number">1534262</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">83.880</span>...<span class="params">| 39|</span><span class="number">063</span><span class="params">|01074044|</span><span class="number">39063</span><span class="params">|    Hancock|</span>      Hancock County<span class="params">| 06|</span> H1<span class="params">|G4020|</span> <span class="number">248</span><span class="params">|22300|</span>null<span class="params">|   A|</span><span class="number">1376210232</span><span class="params">| 5959837|</span>+<span class="number">41.0004711</span><span class="params">|-083.6660335|</span></span><br><span class="line"><span class="params">|POLYGON ((-102.08...|</span> <span class="number">48</span><span class="params">|189|</span>01383880<span class="params">|48189|</span>       Hale<span class="params">|         Hale County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">|null|</span><span class="number">38380</span><span class="params">|null|</span>   A<span class="params">|2602115649|</span>  <span class="number">246678</span><span class="params">|+34.0684364|</span>-<span class="number">101.8228879</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">85.978</span>...<span class="params">| 01|</span><span class="number">027</span><span class="params">|00161539|</span><span class="number">01027</span><span class="params">|       Clay|</span>         Clay County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">| null|</span>null<span class="params">|   A|</span><span class="number">1564252367</span><span class="params">| 5284573|</span>+<span class="number">33.2703999</span><span class="params">|-085.8635254|</span></span><br><span class="line"><span class="params">|POLYGON ((-101.62...|</span> <span class="number">48</span><span class="params">|011|</span>01383791<span class="params">|48011|</span>  Armstrong<span class="params">|    Armstrong County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">| 108|</span><span class="number">11100</span><span class="params">|null|</span>   A<span class="params">|2354581764|</span><span class="number">12219587</span><span class="params">|+34.9641790|</span>-<span class="number">101.3566363</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">84.397</span>...<span class="params">| 39|</span><span class="number">003</span><span class="params">|01074015|</span><span class="number">39003</span><span class="params">|      Allen|</span>        Allen County<span class="params">| 06|</span> H1<span class="params">|G4020|</span> <span class="number">338</span><span class="params">|30620|</span>null<span class="params">|   A|</span><span class="number">1042470093</span><span class="params">|11266164|</span>+<span class="number">40.7716274</span><span class="params">|-084.1061032|</span></span><br><span class="line"><span class="params">|POLYGON ((-82.449...|</span> <span class="number">13</span><span class="params">|189|</span>00348794<span class="params">|13189|</span>   McDuffie<span class="params">|     McDuffie County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">|null|</span><span class="number">12260</span><span class="params">|null|</span>   A<span class="params">| 666816637|</span><span class="number">23116292</span><span class="params">|+33.4824637|</span>-082.<span class="number">4731880</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">90.191</span>...<span class="params">| 55|</span><span class="number">111</span><span class="params">|01581115|</span><span class="number">55111</span><span class="params">|       Sauk|</span>         Sauk County<span class="params">| 06|</span> H1<span class="params">|G4020|</span> <span class="number">357</span><span class="params">|12660|</span>null<span class="params">|   A|</span><span class="number">2152007753</span><span class="params">|45296336|</span>+<span class="number">43.4279976</span><span class="params">|-089.9433290|</span></span><br><span class="line"><span class="params">|POLYGON ((-92.415...|</span> <span class="number">05</span><span class="params">|137|</span>00069902<span class="params">|05137|</span>      Stone<span class="params">|        Stone County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">|null|</span> null<span class="params">|null|</span>   A<span class="params">|1570579427|</span> <span class="number">7841929</span><span class="params">|+35.8570312|</span>-092.<span class="number">1405728</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">117.74</span>...<span class="params">| 41|</span><span class="number">063</span><span class="params">|01155135|</span><span class="number">41063</span><span class="params">|    Wallowa|</span>      Wallowa County<span class="params">| 06|</span> H1<span class="params">|G4020|</span>null<span class="params">| null|</span>null<span class="params">|   A|</span><span class="number">8148602810</span><span class="params">|14199330|</span>+<span class="number">45.5937530</span><span class="params">|-117.1855796|</span></span><br><span class="line"><span class="params">|POLYGON ((-80.518...|</span> <span class="number">42</span><span class="params">|007|</span><span class="number">01214112</span><span class="params">|42007|</span>     Beaver<span class="params">|       Beaver County|</span> <span class="number">06</span><span class="params">| H1|</span>G4020<span class="params">| 430|</span><span class="number">38300</span><span class="params">|null|</span>   A<span class="params">|1125901160|</span><span class="number">24165972</span><span class="params">|+40.6841401|</span>-080.<span class="number">3507209</span><span class="params">|</span></span><br><span class="line"><span class="params">+--------------------+---+---+--------+-----+-----------+--------------------+---+---+-----+----+-----+----+----+----------+--------+-----------+------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="构建空间要素"><a href="#构建空间要素" class="headerlink" title="构建空间要素"></a>构建空间要素</h3><p>这里用到了<code>ST_GeomFromWKT</code>这个函数，他读取一个WKT字符串，然后将其转为Geometry</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String sqlText = <span class="string">&quot;select ST_GeomFromWKT(_c0) AS countyshape, _c1, _c2, _c6 from rawdf&quot;</span>;</span><br><span class="line">Dataset spatialDf  = spark.sql(sqlText);</span><br><span class="line">spatialDf.createOrReplaceTempView(<span class="string">&quot;spatialdf&quot;</span>);</span><br><span class="line">spatialDf.show(<span class="number">10</span>);</span><br><span class="line">spatialDf.printSchema();</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+---+---+</span><br><span class="line"><span class="params">|         countyshape|</span>_c1<span class="params">|_c2|</span></span><br><span class="line">+--------------------+---+---+</span><br><span class="line"><span class="params">|POLYGON ((-97.019...|</span> <span class="number">31</span><span class="params">|039|</span></span><br><span class="line"><span class="params">|POLYGON ((-123.43...|</span> <span class="number">53</span><span class="params">|069|</span></span><br><span class="line"><span class="params">|POLYGON ((-104.56...|</span> <span class="number">35</span><span class="params">|011|</span></span><br><span class="line"><span class="params">|POLYGON ((-96.910...|</span> <span class="number">31</span><span class="params">|109|</span></span><br><span class="line"><span class="params">|POLYGON ((-98.273...|</span> <span class="number">31</span><span class="params">|129|</span></span><br><span class="line"><span class="params">|POLYGON ((-65.910...|</span> <span class="number">72</span><span class="params">|085|</span></span><br><span class="line"><span class="params">|POLYGON ((-97.129...|</span> <span class="number">46</span><span class="params">|099|</span></span><br><span class="line"><span class="params">|POLYGON ((-99.821...|</span> <span class="number">48</span><span class="params">|327|</span></span><br><span class="line"><span class="params">|POLYGON ((-120.65...|</span> <span class="number">06</span><span class="params">|091|</span></span><br><span class="line"><span class="params">|POLYGON ((-85.239...|</span> <span class="number">21</span><span class="params">|053|</span></span><br><span class="line">+--------------------+---+---+</span><br></pre></td></tr></table></figure>

<p>我们调用<code>spatialDf.printSchema()</code>输出每一列的元信息，检验一下是否转换成功，可以看到countyshape那列已经是geometry了。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line"> |-- countyshape: geometry (<span class="keyword">nullable</span> = <span class="literal">false</span>)</span><br><span class="line"> |-- _c1: string (<span class="keyword">nullable</span> = <span class="literal">true</span>)</span><br><span class="line"> |-- _c2: string (<span class="keyword">nullable</span> = <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h3 id="坐标系转换"><a href="#坐标系转换" class="headerlink" title="坐标系转换"></a>坐标系转换</h3><p>我们来尝试使用第一个GeoSpark提供的函数<code>ST_Transform</code>来完成一个简单的操作:坐标转换。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sqlText = <span class="string">&quot;select ST_Transform(countyshape, &#x27;epsg:4326&#x27;, &#x27;epsg:3857&#x27;) as newcountyshape, countyshape, _c1, _c2, _c6 from spatialdf&quot;</span>;</span><br><span class="line">spatialDf = spark.sql(sqlText);</span><br><span class="line">spatialDf.createOrReplaceTempView(<span class="string">&quot;spatialdf&quot;</span>);</span><br><span class="line">spatialDf.show(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>newcountyshape是转换后的，可以看到坐标已经发生了变化</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+--------------------+---+---+</span><br><span class="line"><span class="params">|      newcountyshape|</span>         countyshape<span class="params">|_c1|</span>_c2<span class="params">|</span></span><br><span class="line"><span class="params">+--------------------+--------------------+---+---+</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">108001</span>...<span class="params">|POLYGON ((-97.019...|</span> <span class="number">31</span><span class="params">|039|</span></span><br><span class="line"><span class="params">|POLYGON ((-137408...|</span>POLYGON ((-<span class="number">123.43</span>...<span class="params">| 53|</span>069<span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">116403</span>...<span class="params">|POLYGON ((-104.56...|</span> <span class="number">35</span><span class="params">|011|</span></span><br><span class="line"><span class="params">|POLYGON ((-107880...|</span>POLYGON ((-<span class="number">96.910</span>...<span class="params">| 31|</span><span class="number">109</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">109397</span>...<span class="params">|POLYGON ((-98.273...|</span> <span class="number">31</span><span class="params">|129|</span></span><br><span class="line"><span class="params">|POLYGON ((-733712...|</span>POLYGON ((-<span class="number">65.910</span>...<span class="params">| 72|</span>085<span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">108123</span>...<span class="params">|POLYGON ((-97.129...|</span> <span class="number">46</span><span class="params">|099|</span></span><br><span class="line"><span class="params">|POLYGON ((-111121...|</span>POLYGON ((-<span class="number">99.821</span>...<span class="params">| 48|</span><span class="number">327</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">134313</span>...<span class="params">|POLYGON ((-120.65...|</span> <span class="number">06</span><span class="params">|091|</span></span><br><span class="line"><span class="params">|POLYGON ((-948877...|</span>POLYGON ((-<span class="number">85.239</span>...<span class="params">| 21|</span><span class="number">053</span><span class="params">|</span></span><br><span class="line"><span class="params">+--------------------+--------------------+---+---+</span></span><br></pre></td></tr></table></figure>

<h3 id="范围查询"><a href="#范围查询" class="headerlink" title="范围查询"></a>范围查询</h3><p>接下来我们尝试使用<code>ST_contains</code>来进行范围查询，我们首先通过<code>ST_PolygonFromEnvelope</code>构建一个查询范围，当然你也可以根据自己的需要使用GeoSpark提供的其他SQL函数来构建Polygon、Point、Line等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sqlText = <span class="string">&quot;select * from spatialdf where ST_contains(ST_PolygonFromEnvelope(-98.0,-97.0,111.0,111.0), countyshape)&quot;</span>;</span><br><span class="line">spatialDf = spark.sql(sqlText);</span><br><span class="line">spatialDf.createOrReplaceTempView(<span class="string">&quot;spatialdf&quot;</span>);</span><br><span class="line">spatialDf.show(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>查询结果：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">+--------------------+--------------------+---+---+</span><br><span class="line"><span class="params">|      newcountyshape|</span>         countyshape<span class="params">|_c1|</span>_c2<span class="params">|</span></span><br><span class="line"><span class="params">+--------------------+--------------------+---+---+</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">108001</span>...<span class="params">|POLYGON ((-97.019...|</span> <span class="number">31</span><span class="params">|039|</span></span><br><span class="line"><span class="params">|POLYGON ((-107880...|</span>POLYGON ((-<span class="number">96.910</span>...<span class="params">| 31|</span><span class="number">109</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">733712</span>...<span class="params">|POLYGON ((-65.910...|</span> <span class="number">72</span><span class="params">|085|</span></span><br><span class="line"><span class="params">|POLYGON ((-108123...|</span>POLYGON ((-<span class="number">97.129</span>...<span class="params">| 46|</span>099<span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">948877</span>...<span class="params">|POLYGON ((-85.239...|</span> <span class="number">21</span><span class="params">|053|</span></span><br><span class="line"><span class="params">|POLYGON ((-933756...|</span>POLYGON ((-<span class="number">83.880</span>...<span class="params">| 39|</span><span class="number">063</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">957111</span>...<span class="params">|POLYGON ((-85.978...|</span> <span class="number">01</span><span class="params">|027|</span></span><br><span class="line"><span class="params">|POLYGON ((-939505...|</span>POLYGON ((-<span class="number">84.397</span>...<span class="params">| 39|</span><span class="number">003</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>POLYGON ((-<span class="number">917828</span>...<span class="params">|POLYGON ((-82.449...|</span> <span class="number">13</span><span class="params">|189|</span></span><br><span class="line"><span class="params">|POLYGON ((-100401...|</span>POLYGON ((-<span class="number">90.191</span>...<span class="params">| 55|</span><span class="number">111</span><span class="params">|</span></span><br><span class="line"><span class="params">+--------------------+--------------------+---+---+</span></span><br></pre></td></tr></table></figure>

<h3 id="KNN临近查询"><a href="#KNN临近查询" class="headerlink" title="KNN临近查询"></a>KNN临近查询</h3><p>接下来，我们来使用SQL完成上一节中的KNN临近查询，我们直接对距离排序，然后取出前K个即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sqlText = <span class="string">&quot;select _c6 AS countyname, ST_Distance(ST_PointFromText(&#x27;-98.0,111.0&#x27;,&#x27;,&#x27;), countyshape) AS distance &quot;</span> +</span><br><span class="line">        <span class="string">&quot;from spatialdf &quot;</span> +</span><br><span class="line">        <span class="string">&quot;order by distance ASC &quot;</span> +</span><br><span class="line">        <span class="string">&quot;LIMIT 5&quot;</span>;</span><br><span class="line">spatialDf = spark.sql(sqlText);</span><br><span class="line">spatialDf.createOrReplaceTempView(<span class="string">&quot;spatialdf&quot;</span>);</span><br><span class="line">spatialDf.show();</span><br></pre></td></tr></table></figure>

<p>查询结果如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----------------+-----------------+</span><br><span class="line"><span class="params">|      countyname|</span>         distance<span class="params">|</span></span><br><span class="line"><span class="params">+----------------+-----------------+</span></span><br><span class="line"><span class="params">|</span>Marquette County<span class="params">|64.55326972977753|</span></span><br><span class="line"><span class="params">|Menominee County|</span><span class="number">65.83787128210902</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span> Leelanau County<span class="params">|  66.425519281423|</span></span><br><span class="line"><span class="params">|Minnehaha County|</span><span class="number">67.15767429101942</span><span class="params">|</span></span><br><span class="line"><span class="params">|</span>   Alpena County<span class="params">|67.29568076938793|</span></span><br><span class="line">+----------------+-----------------+</span><br></pre></td></tr></table></figure>
  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Geospark-SQL%E7%AE%80%E4%BB%8B"><span class="toc-text">Geospark SQL简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#GeoSpark-SQL%E7%AE%80%E4%BB%8B"><span class="toc-text">GeoSpark SQL简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E6%95%B0%E6%8D%AE%E9%9B%86%EF%BC%8C%E5%8A%A0%E8%BD%BDCSV%E6%96%87%E4%BB%B6"><span class="toc-text">构建数据集，加载CSV文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E5%BB%BA%E7%A9%BA%E9%97%B4%E8%A6%81%E7%B4%A0"><span class="toc-text">构建空间要素</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9D%90%E6%A0%87%E7%B3%BB%E8%BD%AC%E6%8D%A2"><span class="toc-text">坐标系转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-text">范围查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#KNN%E4%B8%B4%E8%BF%91%E6%9F%A5%E8%AF%A2"><span class="toc-text">KNN临近查询</span></a></li></ol></li></ol></li></ol>
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: 张学亮</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">http://xueliang666.github.com/2021/04/29/%EF%BC%88%E5%9B%9B%EF%BC%89Geospark%20SQL%E7%AE%80%E4%BB%8B/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
    <div class="passage-tags">
     
      <a href="/tags/GeoMesa/"><i class="fa fa-tags"></i>GeoMesa</a>
     
      <a href="/tags/Spark/"><i class="fa fa-tags"></i>Spark</a>
    
    </div>
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2021 <a href="https://zhangxueliang.blog.csdn.net/" target="_blank">学亮编程手记</a>.
      Created by <a href="https://zhangxueliang.blog.csdn.net/" target="_blank">张学亮</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="/2021/04/29/%EF%BC%88%E4%BA%94%EF%BC%89GeosparkViz%20%E5%8F%AF%E8%A7%86%E5%8C%96/" data-enable="true">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/2021/04/29/%EF%BC%88%E4%B8%89%EF%BC%89Geospark%E7%A9%BA%E9%97%B4%E6%9F%A5%E8%AF%A2/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
    <a id="share-btn-twitter" href="javascript:void(0);" target="_blank">
      <i class="fa fa-twitter"></i>
    </a>
  
  
    <a id="share-btn-facebook" href="javascript:void(0);" target="_blank">
      <i class="fa fa-facebook"></i>
    </a>
  
  
    <a id="share-btn-weibo" href="javascript:void(0);" target="_blank">
      <i class="fa fa-weibo"></i>
    </a>
  
  
    <a id="share-btn-qq" href="javascript:void(0);" target="_blank">
      <i class="fa fa-qq"></i>
    </a>
  
  
    <a id="share-btn-wechat" href="javascript:void(0);" target="_blank">
      <i class="fa fa-wechat"></i>
    </a>
  
</div>
    





    
  </body>
</html>